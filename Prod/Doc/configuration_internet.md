#### Configuration de la connexion internet


Distribution de travail : Ubuntu 20.04 LTS


### I/ Sur le serveur : Priorisation de l'interface réseau.

### 1/ Installation des outils de configuration réseau.

```
util01@server:~$ sudo apt-get install net-tools ifmetric
```


### 2/ Vérification des adresses ip des interfaces réseaux.


Interfaces réseau du serveur Ubuntu. 
Récupérer les paramètres des cartes réseaux et adresses IP respectives

```
util01@server:~$ ip a
```

Réseau Raspberry :
Interface réseau :  enp3s0
@ip : 192.168.1.100

Réseau pédagogique collège :
Interface réseau :  enp5s0
@ip : 10.108.39.60 (addresse attribuée par le serveur DHCP du réseau pédagogique du collège)


### 3/ Affichage des routes.

```
util01@server:~$ route -n
```


### 4/ Priorisation de l'interface réseau ayant Internet.

```
util01@server:~$ sudo ifmetric enp5s0 50
```

```
util01@server:~$ route -n
Table de routage IP du noyau
Destination     Passerelle      Genmask         Indic Metric Ref    Use Iface
0.0.0.0         10.108.39.1     0.0.0.0         UG    100    0        0 enp5s0
0.0.0.0         192.168.1.1     0.0.0.0         UG    20101  0        0 enp3s0
10.108.39.0     0.0.0.0         255.255.255.0   U     100    0        0 enp5s0
169.254.0.0     0.0.0.0         255.255.0.0     U     1000   0        0 enp5s0
192.168.1.0     0.0.0.0         255.255.255.0   U     101    0        0 enp3s0
```


### II/ Sur le serveur : Activation permanente de resolv.conf

### 1/ Installation de l'outil de gestion de resolver.

Liens :
https://www.tecmint.com/set-permanent-dns-nameservers-in-ubuntu-debian/
https://www.ricmedia.com/set-permanent-dns-nameservers-ubuntu-debian-resolv-conf/


```
util01@server:~$ sudo apt install resolvconf
```


### 2/ Activation et démarrage du service resolv.conf

```
util01@server:~$ sudo systemctl enable resolvconf.service
util01@server:~$ sudo systemctl start resolvconf.service
util01@server:~$ sudo systemctl status resolvconf.service
```


### 3/ Ajout de serveurs DNS.


Ouvrir : 

```
util01@server:~$ sudo nano /etc/resolvconf/resolv.conf.d/head
```

Ajouter :

```
nameserver 8.8.8.8 
nameserver 8.8.4.4
```


### 4/ Redémarrer le serveur.


### 5/ Vérification.

```
util01@server:~$ cat /etc/resolv.conf 
# Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
# 127.0.0.53 is the systemd-resolved stub resolver.
# run "systemd-resolve --status" to see details about the actual nameservers.
nameserver 8.8.8.8 
nameserver 8.8.4.4
nameserver 127.0.0.1
```


### 6/ Test.

```
util01@server:~$ ping google.fr -c 2
PING google.fr (172.217.16.131) 56(84) bytes of data.
64 bytes from fra15s46-in-f3.1e100.net (172.217.16.131): icmp_seq=1 ttl=116 time=103 ms
64 bytes from fra15s46-in-f3.1e100.net (172.217.16.131): icmp_seq=2 ttl=116 time=124 ms

--- google.fr ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1001ms
rtt min/avg/max/mdev = 102.914/113.605/124.297/10.691 ms
```


### III/ Sur le serveur : Redirection du trafic réseau.

Liens :
https://help.ubuntu.com/community/Internet/ConnectionSharing
https://www.wikihow.com/Add-or-Change-the-Default-Gateway-in-Linux
https://askubuntu.com/questions/790001/sharing-connection-ip192.168.30.255,proxytables
https://www.digitalocean.com/community/tutorials/how-to-list-and-delete-iptables-firewall-rules


### 1/ Activation du routage de paquet.

Ouvrir : 

```
util01@server:~$ sudo nano /etc/sysctl.conf
```

Chercher et décommenter : 

```
net.ipv4.ip_forward=1
```


### 2/ Réglage des régles Iptables.

- Créer une connexion entre les 2 interfaces réseaux :
Adapter le nom des interfaces réseaux (ici enp5s0 correspond à l'interface lié au réseau pédagogique du collège et enp3s0 correspond au réseau Raspberry) et l'adresse IP (192.16.1.100 correspond à l'IP du serveur sur le réseau Raspberry) 

```
util01@server:~$ sudo iptables -A FORWARD -o enp5s0 -i enp3s0 -s 192.168.1.100/24 -m conntrack --ctstate NEW -j ACCEPT
```

- Trace les connexions :

```
util01@server:~$ sudo iptables -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
```

- Routage d'adresse :

```
util01@server:~$ sudo iptables -t nat -F POSTROUTING
```

- Masquage d'adresse IP :

```
util01@server:~$ sudo iptables -t nat -A POSTROUTING -o enp5s0 -j MASQUERADE
```

- Liste les règles Iptables :

```
util01@server:~$ sudo iptables -L -t nat -v
```


### 3/ Persistance des régles Iptables.

```
util01@server:~$ sudo apt-get install iptables-persistent
util01@server:~$ sudo systemctl is-enabled netfilter-persistent.service
util01@server:~$ sudo systemctl status netfilter-persistent.service
```

### IV/ Sur le client : Configuration de resolv.conf sur l'image du Raspberrypi


### 1/ Allumer un Raspberry  Pi

- Sur le terminal du Raspberry, trouver l'adresse ip du Raspberry Pi, ici 192.168.1.75 :

```
pi@raspberrypi:~$ ip a
```

- Sur le terminal du serveur
```
util01@server:~$ ssh pi@192.168.1.75
```


### 2/ Activer l'accès internet provisoire

Ouvrir le fichier resolv.conf

```
pi@raspberrypi:~ $ sudo nano /etc/resolv.conf
```


Effacer tout et ajouter :

```
nameserver 8.8.8.8 
nameserver 8.8.4.4
```


### 3/ Installation de l'outil de configuration resolv.conf

```
pi@raspberrypi:~ $ sudo apt install resolvconf
```


### 4/ Activation et démarrage du service resolver.

```
pi@raspberrypir:~$ sudo systemctl enable resolvconf.service
pi@raspberrypi:~$ sudo systemctl start resolvconf.service
pi@raspberrypi:~$ sudo systemctl status resolvconf.service
```


### 5/ Ajout de serveurs DNS.

Ouvrir : 

```
/etc/resolvconf/resolv.conf.d/head
```

Ajouter :

```
nameserver 8.8.8.8 
nameserver 8.8.4.4
```


### 6/ Ajout du proxy.

A partir du serveur, se connecter en ssh à l'image RaspOs :

```
util01@server:~$ ssh pi@192.168.1.75
```


Ouvrir le fichier environment :

```
pi@raspberrypi:~ $ sudo nano /etc/environment
```

Ajouter :

```
export http_proxy="http://192.168.224.254:3128"
export https_proxy="https://192.168.224.254:3128"
export no_proxy="localhost, 127.0.0.1"
```


Ouvrir visudo :

```
pi@raspberrypi:~ $ sudo visudo
```

Ajouter :

```
Defaults        env_keep+="http_proxy https_proxy no_proxy"
```


### 7/ Configuration du proxy pour le terminal pour l'outil apt.

Lien : 
https://riptutorial.com/fr/raspberry-pi/example/25054/configuration-du-proxy

Ouvrir : 

```
pi@raspberrypi:~ $ sudo /etc/apt/apt.conf.d/10proxy
```

Ajouter : 

```
Acquire::http::Proxy "http://192.168.224.254:3128/";
Acquire::https::Proxy "https://192.168.224.254:3128/";
```


### 8/ Arrêter et redémarrer le Raspberry Pi 4 et le serveur.


### 9/ Vérification.

```
pi@raspberrypi:~ $ cat /etc/resolv.conf
# Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
nameserver 192.168.2.100
nameserver 8.8.8.8
nameserver 8.8.4.4
```


### 10/ Tests de connexion.

- Test #1 : Vers le serveur Ubuntu.

```
pi@raspberrypi:~ $ ping 192.168.1.100 -c 2
PING 192.168.1.42 (192.168.1.100) 56(84) bytes of data.
64 bytes from 192.168.1.100: icmp_seq=1 ttl=64 time=0.337 ms
64 bytes from 192.168.1.100: icmp_seq=2 ttl=64 time=0.406 ms

--- 192.168.1.42 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 51ms
rtt min/avg/max/mdev = 0.337/0.371/0.406/0.039 ms
pi@raspberrypi:~ $ 
```

- Test #2 : Vers un des serveurs DNS de Google.

```
pi@raspberrypi:~ $ ping 8.8.8.8 -c 3
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_seq=1 ttl=114 time=35.6 ms
64 bytes from 8.8.8.8: icmp_seq=2 ttl=114 time=101 ms
64 bytes from 8.8.8.8: icmp_seq=3 ttl=114 time=124 ms

--- 8.8.8.8 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 6ms
rtt min/avg/max/mdev = 35.602/87.013/123.985/37.500 ms
```

- Test #3 : Vers un site web.

```
pi@raspberrypi:~ $ ping rocketchat.hacklab.run -c 2
PING rocketchat.hacklab.run (146.59.154.144) 56(84) bytes of data.
64 bytes from vps-c49a29aa.vps.ovh.net (146.59.154.144): icmp_seq=1 ttl=47 time=200 ms
64 bytes from vps-c49a29aa.vps.ovh.net (146.59.154.144): icmp_seq=2 ttl=47 time=226 ms

--- rocketchat.hacklab.run ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 2ms
rtt min/avg/max/mdev = 200.242/213.087/225.932/12.845 ms
```


### 11/ Test de mise-à-jour et d'installation d'application via apt.

```
pi@raspberrypi:~ $ sudo apt-get update && sudo apt-get upgrade
pi@raspberrypi:~ $ sudo apt-get install vim screen mc links
```
