#### Configuration de la connexion internet


Distribution de travail : Ubuntu 20.04 LTS


Interfaces réseau du serveur Ubuntu. 

```
* enp2s0
@ip : 192.168.2.100
Réseau local avec les Raspberry Pi 4


* wlp4s0
@ip : 192.168.1.42
Réseau local avec une connexion internet
```


### I/ Sur le serveur : Priorisation de l'interface réseau.

### 1/ Installation des outils de configuration réseau.

```
util01@server:~$ sudo apt-get install route net-tools ifmetric
```


### 2/ Vérification des adresses ip des interfaces réseaux.

```
util01@server:~$ ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: enp2s0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 00:16:d3:65:58:d6 brd ff:ff:ff:ff:ff:ff
    inet 192.168.2.100/24 brd 192.168.2.255 scope global noprefixroute enp2s0
       valid_lft forever preferred_lft forever
    inet6 fe80::216:d3ff:fe65:58d6/64 scope link 
       valid_lft forever preferred_lft forever
3: wlp4s0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP group default qlen 1000
    link/ether 00:1b:77:26:7e:93 brd ff:ff:ff:ff:ff:ff
    inet 192.168.1.42/24 brd 192.168.1.255 scope global dynamic noprefixroute wlp4s0
       valid_lft 86308sec preferred_lft 86308sec
    inet6 fe80::c165:8fc2:229d:22c9/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever
```


### 3/ Affichage des routes.

```
util01@server:~$ route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.2.1     0.0.0.0         UG    20100  0        0 enp2s0
0.0.0.0         192.168.1.1     0.0.0.0         UG    20600  0        0 wlp4s0
169.254.0.0     0.0.0.0         255.255.0.0     U     1000   0        0 enp2s0
192.168.1.0     0.0.0.0         255.255.255.0   U     600    0        0 wlp4s0
192.168.2.0     0.0.0.0         255.255.255.0   U     100    0        0 enp2s0
```


### 4/ Priorisation de l'interface réseau ayant Internet.

```
util01@server:~$ sudo ifmetric wlp4s0 50
```

```
util01@server:~$ route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.1.1     0.0.0.0         UG    50     0        0 wlp4s0
0.0.0.0         192.168.2.1     0.0.0.0         UG    20100  0        0 enp2s0
169.254.0.0     0.0.0.0         255.255.0.0     U     1000   0        0 enp2s0
192.168.1.0     0.0.0.0         255.255.255.0   U     50     0        0 wlp4s0
192.168.2.0     0.0.0.0         255.255.255.0   U     100    0        0 enp2s0
```


### II/ Sur le serveur : Activation permanente de resolv.conf

### 1/ Installation de l'outil de gestion de resolver.

Liens :
https://www.tecmint.com/set-permanent-dns-nameservers-in-ubuntu-debian/
https://www.ricmedia.com/set-permanent-dns-nameservers-ubuntu-debian-resolv-conf/


```
util01@server:~$ sudo apt install resolvconf
```


### 2/ Activation et démarrage du service resolv.conf

```
util01@server:~$ sudo systemctl enable resolvconf.service
util01@server:~$ sudo systemctl start resolvconf.service
util01@server:~$ sudo systemctl status resolvconf.service
```

### 3/ Ajout de serveurs DNS.

Ouvrir : 

```
/etc/resolvconf/resolv.conf.d/head
```

Ajouter :

```
nameserver 8.8.8.8 
nameserver 8.8.4.4
```

### 4/ Redémarrer le serveur.


### 5/ Vérification.

```
util01@server:~$ cat /etc/resolv.conf 
# Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
# 127.0.0.53 is the systemd-resolved stub resolver.
# run "systemd-resolve --status" to see details about the actual nameservers.
nameserver 8.8.8.8 
nameserver 8.8.4.4
nameserver 127.0.0.1
```


### 6/ Test.

```
util01@server:~$ ping google.fr -c 2
PING google.fr (172.217.16.131) 56(84) bytes of data.
64 bytes from fra15s46-in-f3.1e100.net (172.217.16.131): icmp_seq=1 ttl=116 time=103 ms
64 bytes from fra15s46-in-f3.1e100.net (172.217.16.131): icmp_seq=2 ttl=116 time=124 ms

--- google.fr ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1001ms
rtt min/avg/max/mdev = 102.914/113.605/124.297/10.691 ms
```


### III/ Sur le serveur : Redirection de trafic réseau.

Liens :
https://help.ubuntu.com/community/Internet/ConnectionSharing
https://www.wikihow.com/Add-or-Change-the-Default-Gateway-in-Linux
https://askubuntu.com/questions/790001/sharing-connection-iptables
https://www.digitalocean.com/community/tutorials/how-to-list-and-delete-iptables-firewall-rules


### 1/ Activation du routage de paquet.

Ouvrir : 

```
/etc/sysctl.conf
```

Chercher et décommenter : 

```
net.ipv4.ip_forward=1
```


### 2/ Réglage des régles Iptables.

- Créer une connexion entre les 2 interfaces réseaux via la redirection de traffic :

```
util01@server:~$ sudo iptables -A FORWARD -o wlp4s0 -i enp2s0 -s 192.168.2.100/24 -m conntrack --ctstate NEW -j ACCEPT
```

- Trace les connexions :

```
util01@server:~$ sudo iptables -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
```

- Routage d'adresse :

```
util01@server:~$ sudo iptables -t nat -F POSTROUTING
```

- Masquage d'adresse ip :

```
util01@server:~$ sudo iptables -t nat -A POSTROUTING -o wlp4s0 -j MASQUERADE
```

- Liste les règles Iptables :

```
util01@server:~$ sudo iptables -L -t nat -v
```


### 3/ Persistance des régles Iptables.

```
util01@server:~$ sudo apt-get install iptables-persistent
util01@server:~$ sudo systemctl is-enabled netfilter-persistent.service
enabled
util01@server:~$ sudo systemctl status netfilter-persistent.service
```


### IV/ Sur le client : Configuration de resolv.conf

### 1/ Installation de l'outil de configuration resolv.conf

```
util01@server:~$ sudo apt install resolvconf
```


### 2/ Activation et démarrage du service resolver.

```
util01@server:~$ sudo systemctl enable resolvconf.service
util01@server:~$ sudo systemctl start resolvconf.service
util01@server:~$ sudo systemctl status resolvconf.service
```


### 3/ Ajout de serveurs DNS.

Ouvrir : 

```
/etc/resolvconf/resolv.conf.d/head
```

Ajouter :

```
nameserver 8.8.8.8 
nameserver 8.8.4.4
```


### 4/ Arrêter et redémarrer le Raspberry Pi 4.


### 5/ Vérification.

```
pi@raspberrypi:~ $ cat /etc/resolv.conf
# Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
nameserver 192.168.2.100
nameserver 8.8.8.8
nameserver 8.8.4.4
```


### 6/ Tests de connexion.

- Test #1 : Vers le serveur Ubuntu.

```
pi@raspberrypi:~ $ ping 192.168.1.42 -c 2
PING 192.168.1.42 (192.168.1.42) 56(84) bytes of data.
64 bytes from 192.168.1.42: icmp_seq=1 ttl=64 time=0.337 ms
64 bytes from 192.168.1.42: icmp_seq=2 ttl=64 time=0.406 ms

--- 192.168.1.42 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 51ms
rtt min/avg/max/mdev = 0.337/0.371/0.406/0.039 ms
pi@raspberrypi:~ $ 
```

- Test #2 : Vers un des serveurs DNS de Google.

```
pi@raspberrypi:~ $ ping 8.8.8.8 -c 3
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_seq=1 ttl=114 time=35.6 ms
64 bytes from 8.8.8.8: icmp_seq=2 ttl=114 time=101 ms
64 bytes from 8.8.8.8: icmp_seq=3 ttl=114 time=124 ms

--- 8.8.8.8 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 6ms
rtt min/avg/max/mdev = 35.602/87.013/123.985/37.500 ms
```

- Test #3 : Vers un site web.

```
pi@raspberrypi:~ $ ping rocketchat.hacklab.run -c 2
PING rocketchat.hacklab.run (146.59.154.144) 56(84) bytes of data.
64 bytes from vps-c49a29aa.vps.ovh.net (146.59.154.144): icmp_seq=1 ttl=47 time=200 ms
64 bytes from vps-c49a29aa.vps.ovh.net (146.59.154.144): icmp_seq=2 ttl=47 time=226 ms

--- rocketchat.hacklab.run ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 2ms
rtt min/avg/max/mdev = 200.242/213.087/225.932/12.845 ms
```


### 7/ Test de mise-à-jour et d'installation d'application via apt.


